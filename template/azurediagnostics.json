{
    "$schema":  "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymenttemplate.json#",
    "contentversion":  "1.0.0.0",
    "parameters":  {
                       "location":  {
                                        "type":  "string",
                                        "defaultvalue":  "chinaeast2"
                                    },
                       "workspacename":  {
                                             "type":  "string"
                                         },
                       "security - AzureFirewall_id":  {
                                                           "defaultValue":  "[newGuid()]",
                                                           "type":  "string"
                                                       },
                       "security - WebApplicationFirewallFirewallEvents_id":  {
                                                                                  "defaultValue":  "[newGuid()]",
                                                                                  "type":  "string"
                                                                              },
                       "security - WebApplicationFirewallGatewayAccessEvents_id":  {
                                                                                       "defaultValue":  "[newGuid()]",
                                                                                       "type":  "string"
                                                                                   },
                       "security - WebApplicationFirewallOverview_id":  {
                                                                            "defaultValue":  "[newGuid()]",
                                                                            "type":  "string"
                                                                        },
                       "security - WebApplicationFirewallWAFTypeEvents_id":  {
                                                                                 "defaultValue":  "[newGuid()]",
                                                                                 "type":  "string"
                                                                             }
                   },
    "resources":  [
                      {
                          "name":  "[parameters('security - AzureFirewall_id')]",
                          "properties":  {
                                             "displayName":  "security - Azure Firewall",
                                             "serializedData":  "{   \"version\": \"Notebook/1.0\",   \"items\": [     {       \"type\": 9,       \"content\": {         \"version\": \"KqlParameterItem/1.0\",         \"query\": \"\",         \"crossComponentResources\": [],         \"parameters\": [           {             \"id\": \"ab7d6c51-d7df-436c-96a2-429163aa50ec\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"TimeRange\",             \"type\": 4,             \"isRequired\": true,             \"value\": {               \"durationMs\": 7776000000             },             \"typeSettings\": {               \"selectableValues\": [                 {                   \"durationMs\": 300000                 },                 {                   \"durationMs\": 900000                 },                 {                   \"durationMs\": 1800000                 },                 {                   \"durationMs\": 3600000                 },                 {                   \"durationMs\": 14400000                 },                 {                   \"durationMs\": 43200000                 },                 {                   \"durationMs\": 86400000                 },                 {                   \"durationMs\": 172800000                 },                 {                   \"durationMs\": 259200000                 },                 {                   \"durationMs\": 604800000                 },                 {                   \"durationMs\": 1209600000                 },                 {                   \"durationMs\": 2419200000                 },                 {                   \"durationMs\": 2592000000                 },                 {                   \"durationMs\": 5184000000                 },                 {                   \"durationMs\": 7776000000                 }               ],               \"allowCustom\": true             }           }         ],         \"style\": \"pills\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\"       },       \"name\": \"parameters - 1\"     },     {       \"type\": 1,       \"content\": {         \"json\": \"# Azure Firewall - overview\"       },       \"name\": \"Main title\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics \\r\\n| where ResourceType == \\\"AZUREFIREWALLS\\\" \\r\\n| summarize Volume=count() by bin(TimeGenerated, {TimeRange:grain})\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Events, by time\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"timechart\"       },       \"customWidth\": \"50\",       \"name\": \"query - 16\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics \\r\\n| where ResourceType == \\\"AZUREFIREWALLS\\\" \\r\\n| summarize Volume=count() by Category, bin(TimeGenerated, {TimeRange:grain})\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Events categories, by time\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"timechart\"       },       \"customWidth\": \"50\",       \"name\": \"Events categories by time\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where Category == \\\"AzureFirewallApplicationRule\\\"\\r\\n| summarize amount = count() by Resource, ResourceGroup\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Firewall per resource group\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"table\"       },       \"customWidth\": \"50\",       \"name\": \"Firewall per resource group\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics \\r\\n| where ResourceType == \\\"AZUREFIREWALLS\\\" \\r\\n| summarize Volume=count() by Category\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Events, by category\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"piechart\"       },       \"customWidth\": \"50\",       \"name\": \"Events by category\"     },     {       \"type\": 1,       \"content\": {         \"json\": \"---\\r\\n# Azure Firewall - Application rule log statitics\"       },       \"name\": \"text - 14\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let ActivityData = AzureDiagnostics\\r\\n| where Category == \\\"AzureFirewallApplicationRule\\\"\\r\\n| parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt:int \\\" \\\" TempDetails\\r\\n| parse TempDetails with \\\"was \\\" Action1 \\\". Reason: \\\" Rule1\\r\\n| parse TempDetails with \\\"to \\\" FQDN \\\":\\\" TargetPortInt:int \\\". Action: \\\" Action2 \\\".\\\" *\\r\\n| parse TempDetails with * \\\". Rule Collection: \\\" RuleCollection2a \\\". Rule:\\\" Rule2a\\r\\n| parse TempDetails with * \\\"Deny.\\\" RuleCollection2b \\\". Proceeding with\\\" Rule2b\\r\\n| extend SourcePort = tostring(SourcePortInt)\\r\\n| extend TargetPort = tostring(TargetPortInt)\\r\\n| extend Action1 = case(Action1 == \\\"denied\\\",\\\"Deny\\\",\\\"Unknown Action\\\")\\r\\n| extend Action = case(Action2 == \\\"\\\",Action1,Action2),Rule = case(Rule2a == \\\"\\\", case(Rule1 == \\\"\\\",case(Rule2b == \\\"\\\",\\\"N/A\\\", Rule2b),Rule1),Rule2a),  RuleCollection = case(RuleCollection2b == \\\"\\\",case(RuleCollection2a == \\\"\\\",\\\"No rule matched\\\",RuleCollection2a), RuleCollection2b),FQDN = case(FQDN == \\\"\\\", \\\"N/A\\\", FQDN),TargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort)\\r\\n| where Action == \\\"Deny\\\";\\r\\nActivityData\\r\\n| summarize Amount=count() by SourceIP\\r\\n| join kind = inner\\r\\n(\\r\\n    ActivityData\\r\\n    | make-series Trend = count() default = 0 on bin(TimeGenerated, 1d) from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SourceIP) on SourceIP\\r\\n    | project-away SourceIP1, TimeGenerated\\r\\n    | top 10 by Amount\\r\\n    | sort by Amount\",         \"size\": 4,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Unique Source IP addresses\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"tiles\",         \"tileSettings\": {           \"titleContent\": {             \"columnMatch\": \"Amount\",             \"formatter\": 12,             \"formatOptions\": {               \"showIcon\": true             }           },           \"subtitleContent\": {             \"columnMatch\": \"SourceIP\",             \"formatter\": 1,             \"formatOptions\": {               \"showIcon\": true             }           },           \"secondaryContent\": {             \"columnMatch\": \"Trend\",             \"formatter\": 9,             \"formatOptions\": {               \"showIcon\": true             }           },           \"showBorder\": false         }       },       \"customWidth\": \"50\",       \"name\": \"query - 4\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics \\n| where Category == \\\"AzureFirewallApplicationRule\\\" \\n| parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt:int \\\" \\\" TempDetails \\n| parse TempDetails with \\\"was \\\" Action1 \\\". Reason: \\\" Rule1 \\n| parse TempDetails with \\\"to \\\" FQDN \\\":\\\" TargetPortInt:int \\\". Action: \\\" Action2 \\\".\\\" *\\n| parse TempDetails with * \\\". Rule Collection: \\\" RuleCollection2a \\\". Rule:\\\" Rule2a \\n| parse TempDetails with * \\\"Deny.\\\" RuleCollection2b \\\". Proceeding with\\\" Rule2b \\n| extend SourcePort = tostring(SourcePortInt) \\n| extend TargetPort = tostring(TargetPortInt) \\n| extend Action1 = case(Action1 == \\\"denied\\\",\\\"Deny\\\",\\\"Unknown Action\\\") \\n| extend Action = case(Action2 == \\\"\\\",Action1,Action2),Rule = case(Rule2a == \\\"\\\", case(Rule1 == \\\"\\\",case(Rule2b == \\\"\\\",\\\"N/A\\\", Rule2b),Rule1),Rule2a),  RuleCollection = case(RuleCollection2b == \\\"\\\",case(RuleCollection2a == \\\"\\\",\\\"No rule matched\\\",RuleCollection2a), RuleCollection2b),FQDN = case(FQDN == \\\"\\\", \\\"N/A\\\", FQDN),TargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort) \\n| where Action == \\\"Deny\\\" \\n|  summarize Amount=dcount(SourceIP) by SourceIP, Protocol, URL = FQDN, TargetPortInt, Action\\n\",         \"size\": 1,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Unique source IP addresses\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"gridSettings\": {           \"formatters\": [             {               \"columnMatch\": \"SourceIP\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"Count\",               \"formatter\": 3,               \"formatOptions\": {                 \"palette\": \"lightBlue\",                 \"showIcon\": true,                 \"aggregation\": \"Count\"               },               \"numberFormat\": {                 \"unit\": 17,                 \"options\": {                   \"style\": \"decimal\"                 }               }             }           ],           \"filter\": true,           \"labelSettings\": []         }       },       \"customWidth\": \"50\",       \"name\": \"query - 2\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics | where Category == \\\"AzureFirewallApplicationRule\\\" | parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt:int \\\" \\\" TempDetails | parse TempDetails with \\\"was \\\" Action1 \\\". Reason: \\\" Rule1 | parse TempDetails with \\\"to \\\" FQDN \\\":\\\" TargetPortInt:int \\\". Action: \\\" Action2 \\\".\\\" * | parse TempDetails with * \\\". Rule Collection: \\\" RuleCollection2a \\\". Rule:\\\" Rule2a | parse TempDetails with * \\\"Deny.\\\" RuleCollection2b \\\". Proceeding with\\\" Rule2b | extend SourcePort = tostring(SourcePortInt) | extend TargetPort = tostring(TargetPortInt) | extend Action1 = case(Action1 == \\\"denied\\\",\\\"Deny\\\",\\\"Unknown Action\\\") | extend Action = case(Action2 == \\\"\\\",Action1,Action2),Rule = case(Rule2a == \\\"\\\", case(Rule1 == \\\"\\\",case(Rule2b == \\\"\\\",\\\"N/A\\\", Rule2b),Rule1),Rule2a),  RuleCollection = case(RuleCollection2b == \\\"\\\",case(RuleCollection2a == \\\"\\\",\\\"No rule matched\\\",RuleCollection2a), RuleCollection2b),FQDN = case(FQDN == \\\"\\\", \\\"N/A\\\", FQDN),TargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort)| where Action == \\\"Deny\\\" \\r\\n| summarize count() by URL=FQDN, bin(TimeGenerated,{TimeRange:grain})\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Denied URLs over time\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"timechart\",         \"tileSettings\": {           \"showBorder\": false         }       },       \"customWidth\": \"70\",       \"name\": \"query - 3\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics \\r\\n| where Category == \\\"AzureFirewallApplicationRule\\\" \\r\\n| parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt:int \\\" \\\" TempDetails \\r\\n| parse TempDetails with \\\"was \\\" Action1 \\\". Reason: \\\" Rule1 \\r\\n| parse TempDetails with \\\"to \\\" FQDN \\\":\\\" TargetPortInt:int \\\". Action: \\\" Action2 \\\".\\\" * \\r\\n| parse TempDetails with * \\\". Rule Collection: \\\" RuleCollection2a \\\". Rule:\\\" Rule2a \\r\\n| parse TempDetails with * \\\"Deny.\\\" RuleCollection2b \\\". Proceeding with\\\" Rule2b \\r\\n| extend SourcePort = tostring(SourcePortInt) \\r\\n| extend TargetPort = tostring(TargetPortInt) \\r\\n| extend Action1 = case(Action1 == \\\"denied\\\",\\\"Deny\\\",\\\"Unknown Action\\\") \\r\\n| extend Action = case(Action2 == \\\"\\\",Action1,Action2),Rule = case(Rule2a == \\\"\\\", case(Rule1 == \\\"\\\",case(Rule2b == \\\"\\\",\\\"N/A\\\", Rule2b),Rule1),Rule2a),  RuleCollection = case(RuleCollection2b == \\\"\\\",case(RuleCollection2a == \\\"\\\",\\\"No rule matched\\\",RuleCollection2a), RuleCollection2b),FQDN = case(FQDN == \\\"\\\", \\\"N/A\\\", FQDN),TargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort)\\r\\n| where Action == \\\"Deny\\\" \\r\\n| summarize count() by URL=FQDN\\r\\n\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"piechart\"       },       \"customWidth\": \"30\",       \"name\": \"query - 7\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics \\r\\n| where Category == \\\"AzureFirewallApplicationRule\\\" \\r\\n| parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt:int \\\" \\\" TempDetails \\r\\n| parse TempDetails with \\\"was \\\" Action1 \\\". Reason: \\\" Rule1 \\r\\n| parse TempDetails with \\\"to \\\" FQDN \\\":\\\" TargetPortInt:int \\\". Action: \\\" Action2 \\\".\\\" * \\r\\n| parse TempDetails with * \\\". Rule Collection: \\\" RuleCollection2a \\\". Rule:\\\" Rule2a \\r\\n| parse TempDetails with * \\\"Deny.\\\" RuleCollection2b \\\". Proceeding with\\\" Rule2b \\r\\n| extend SourcePort = tostring(SourcePortInt) \\r\\n| extend TargetPort = tostring(TargetPortInt)\\r\\n| extend Action1 = case(Action1 == \\\"denied\\\",\\\"Deny\\\",\\\"Unknown Action\\\") \\r\\n| extend Action = case(Action2 == \\\"\\\",Action1,Action2),Rule = case(Rule2a == \\\"\\\", case(Rule1 == \\\"\\\",case(Rule2b == \\\"\\\",\\\"N/A\\\", Rule2b),Rule1),Rule2a),  RuleCollection = case(RuleCollection2b == \\\"\\\",case(RuleCollection2a == \\\"\\\",\\\"No rule matched\\\",RuleCollection2a), RuleCollection2b),FQDN = case(FQDN == \\\"\\\", \\\"N/A\\\", FQDN),TargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort) \\r\\n| where Action == \\\"Allow\\\" \\r\\n| summarize count() by URL=FQDN, bin(TimeGenerated,{TimeRange:grain})\\r\\n\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Allowed URLs over time\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"timechart\"       },       \"customWidth\": \"70\",       \"name\": \"query - 5\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics | where Category == \\\"AzureFirewallApplicationRule\\\" | parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt:int \\\" \\\" TempDetails | parse TempDetails with \\\"was \\\" Action1 \\\". Reason: \\\" Rule1 | parse TempDetails with \\\"to \\\" FQDN \\\":\\\" TargetPortInt:int \\\". Action: \\\" Action2 \\\".\\\" * | parse TempDetails with * \\\". Rule Collection: \\\" RuleCollection2a \\\". Rule:\\\" Rule2a | parse TempDetails with * \\\"Deny.\\\" RuleCollection2b \\\". Proceeding with\\\" Rule2b | extend SourcePort = tostring(SourcePortInt) | extend TargetPort = tostring(TargetPortInt) | extend Action1 = case(Action1 == \\\"denied\\\",\\\"Deny\\\",\\\"Unknown Action\\\") | extend Action = case(Action2 == \\\"\\\",Action1,Action2),Rule = case(Rule2a == \\\"\\\", case(Rule1 == \\\"\\\",case(Rule2b == \\\"\\\",\\\"N/A\\\", Rule2b),Rule1),Rule2a),  RuleCollection = case(RuleCollection2b == \\\"\\\",case(RuleCollection2a == \\\"\\\",\\\"No rule matched\\\",RuleCollection2a), RuleCollection2b),FQDN = case(FQDN == \\\"\\\", \\\"N/A\\\", FQDN),TargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort) | where Action == \\\"Allow\\\" \\r\\n| summarize count() by URL=FQDN\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"piechart\"       },       \"customWidth\": \"30\",       \"name\": \"query - 2\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics \\r\\n| where Category == \\\"AzureFirewallApplicationRule\\\" \\r\\n| parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt:int \\\" \\\" TempDetails \\r\\n| parse TempDetails with \\\"was \\\" Action1 \\\". Reason: \\\" Rule1 \\r\\n| parse TempDetails with \\\"to \\\" FQDN \\\":\\\" TargetPortInt:int \\\". Action: \\\" Action2 \\\".\\\" * \\r\\n| parse TempDetails with * \\\". Rule Collection: \\\" RuleCollection2a \\\". Rule:\\\" Rule2a \\r\\n| parse TempDetails with * \\\"Deny.\\\" RuleCollection2b \\\". Proceeding with\\\" Rule2b \\r\\n| extend SourcePort = tostring(SourcePortInt) \\r\\n| extend TargetPort = tostring(TargetPortInt)\\r\\n| extend Action1 = case(Action1 == \\\"denied\\\",\\\"Deny\\\",\\\"Unknown Action\\\") \\r\\n| extend Action = case(Action2 == \\\"\\\",Action1,Action2),Rule = case(Rule2a == \\\"\\\", case(Rule1 == \\\"\\\",case(Rule2b == \\\"\\\",\\\"N/A\\\", Rule2b),Rule1),Rule2a),  RuleCollection = case(RuleCollection2b == \\\"\\\",case(RuleCollection2a == \\\"\\\",\\\"No rule matched\\\",RuleCollection2a), RuleCollection2b),FQDN = case(FQDN == \\\"\\\", \\\"N/A\\\", FQDN),TargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort) \\r\\n| summarize count() by URL=FQDN, bin(TimeGenerated,{TimeRange:grain}), Action, SourcePort, TargetPort\\r\\n\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"All IP addresses events\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"gridSettings\": {           \"formatters\": [             {               \"columnMatch\": \"URL\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"TimeGenerated\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"Action\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"SourcePort\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"TargetPort\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"count_\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             }           ],           \"filter\": true,           \"labelSettings\": []         }       },       \"name\": \"query - 9\"     },     {       \"type\": 1,       \"content\": {         \"json\": \"---\\r\\n# Azure Firewall - Network rule log statistics\"       },       \"name\": \"text - 14\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics \\r\\n| where Category == \\\"AzureFirewallNetworkRule\\\" \\r\\n| parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt:int \\\" to \\\" TargetIP \\\":\\\" TargetPortInt:int * \\r\\n| parse msg_s with * \\\". Action: \\\" Action1a \\r\\n| parse msg_s with * \\\"was \\\" Action1b \\\" to \\\" NatDestination \\r\\n| parse msg_s with Protocol2 \\\" request from \\\" SourceIP2 \\\" to \\\" TargetIP2 \\\". Action:\\\" Action2 \\r\\n| extend SourcePort = tostring(SourcePortInt),TargetPort = tostring(TargetPortInt) \\r\\n| extend Action = case(Action1a == \\\"\\\", case(Action1b == \\\"\\\",Action2,Action1b), Action1a),Protocol = case(Protocol == \\\"\\\", Protocol2, Protocol),SourceIP = case(SourceIP == \\\"\\\", SourceIP2, SourceIP),TargetIP = case(TargetIP == \\\"\\\", TargetIP2, TargetIP),SourcePort = case(SourcePort == \\\"\\\", \\\"N/A\\\", SourcePort),TargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort),NatDestination = case(NatDestination == \\\"\\\", \\\"N/A\\\", NatDestination)  \\r\\n| summarize count() by Action\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Rule actions\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"piechart\"       },       \"customWidth\": \"33\",       \"name\": \"query - 7\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics \\r\\n| where Category == \\\"AzureFirewallNetworkRule\\\" \\r\\n| parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt:int \\\" to \\\" TargetIP \\\":\\\" TargetPortInt:int * \\r\\n| parse msg_s with * \\\". Action: \\\" Action1a \\r\\n| parse msg_s with * \\\"was \\\" Action1b \\\" to \\\" NatDestination \\r\\n| parse msg_s with Protocol2 \\\" request from \\\" SourceIP2 \\\" to \\\" TargetIP2 \\\". Action: \\\" Action2 \\r\\n| extend SourcePort = tostring(SourcePortInt),TargetPort = tostring(TargetPortInt) \\r\\n| extend Action = case(Action1a == \\\"\\\", case(Action1b == \\\"\\\",Action2,Action1b), Action1a),Protocol = case(Protocol == \\\"\\\", Protocol2, Protocol),SourceIP = case(SourceIP == \\\"\\\", SourceIP2, SourceIP),TargetIP = case(TargetIP == \\\"\\\", TargetIP2, TargetIP),SourcePort = case(SourcePort == \\\"\\\", \\\"N/A\\\", SourcePort),TargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort), NatDestination = case(NatDestination == \\\"\\\", \\\"N/A\\\", NatDestination)  \\r\\n| summarize Count=count() by TargetPort\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Target ports\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"piechart\"       },       \"customWidth\": \"33\",       \"name\": \"query - 10\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics \\r\\n| where Category == \\\"AzureFirewallNetworkRule\\\" \\r\\n| parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt:int \\\" to \\\" TargetIP \\\":\\\" TargetPortInt:int * \\r\\n| parse msg_s with * \\\". Action: \\\" Action1a \\r\\n| parse msg_s with * \\\"was \\\" Action1b \\\" to \\\" NatDestination\\r\\n| parse msg_s with Protocol2 \\\" request from \\\" SourceIP2 \\\" to \\\" TargetIP2 \\\". Action:\\\" Action2 \\r\\n| extend SourcePort = tostring(SourcePortInt),TargetPort = tostring(TargetPortInt) \\r\\n| extend Action = case(Action1a == \\\"\\\", \\r\\ncase(Action1b == \\\"\\\",Action2,Action1b), Action1a),\\r\\nProtocol = case(Protocol == \\\"\\\", Protocol2, Protocol),\\r\\nSourceIP = case(SourceIP == \\\"\\\", SourceIP2, SourceIP),\\r\\nTargetIP = case(TargetIP == \\\"\\\", TargetIP2, TargetIP),\\r\\nSourcePort = case(SourcePort == \\\"\\\", \\\"N/A\\\", SourcePort),\\r\\nTargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort),\\r\\nNatDestination = case(NatDestination == \\\"\\\", \\\"N/A\\\", NatDestination)  \\r\\n| where Action == \\\"DNAT'ed\\\"\\r\\n| summarize Amount=count() by NatDestination\\r\\n\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"DNAT actions\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"piechart\"       },       \"customWidth\": \"30\",       \"name\": \"query - 12\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics \\r\\n| where Category == \\\"AzureFirewallNetworkRule\\\" \\r\\n| parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt:int \\\" to \\\" TargetIP \\\":\\\" TargetPortInt:int * \\r\\n| parse msg_s with * \\\". Action: \\\" Action1a \\r\\n| parse msg_s with * \\\"was \\\" Action1b \\\" to \\\" NatDestination\\r\\n| parse msg_s with Protocol2 \\\" request from \\\" SourceIP2 \\\" to \\\" TargetIP2 \\\". Action:\\\" Action2 \\r\\n| extend SourcePort = tostring(SourcePortInt),TargetPort = tostring(TargetPortInt) \\r\\n| extend Action = case(Action1a == \\\"\\\", \\r\\ncase(Action1b == \\\"\\\",Action2,Action1b), Action1a),\\r\\nProtocol = case(Protocol == \\\"\\\", Protocol2, Protocol),\\r\\nSourceIP = case(SourceIP == \\\"\\\", SourceIP2, SourceIP),\\r\\nTargetIP = case(TargetIP == \\\"\\\", TargetIP2, TargetIP),\\r\\nSourcePort = case(SourcePort == \\\"\\\", \\\"N/A\\\", SourcePort),\\r\\nTargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort),\\r\\nNatDestination = case(NatDestination == \\\"\\\", \\\"N/A\\\", NatDestination)  \\r\\n| summarize amount = count() by Action , SourceIP\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Rule actions, by IP addresses\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"table\",         \"gridSettings\": {           \"formatters\": [             {               \"columnMatch\": \"SourceIP\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"eventCount\",               \"formatter\": 3,               \"formatOptions\": {                 \"min\": 0,                 \"palette\": \"blue\",                 \"showIcon\": true               }             }           ],           \"filter\": true,           \"labelSettings\": []         }       },       \"customWidth\": \"33\",       \"name\": \"query - 8\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics \\r\\n| where Category == \\\"AzureFirewallNetworkRule\\\" \\r\\n| parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt:int \\\" to \\\" TargetIP \\\":\\\" TargetPortInt:int * \\r\\n| parse msg_s with * \\\". Action: \\\" Action1a \\r\\n| parse msg_s with * \\\"was \\\" Action1b \\\" to \\\" NatDestination \\r\\n| parse msg_s with Protocol2 \\\" request from \\\" SourceIP2 \\\" to \\\" TargetIP2 \\\". Action: \\\" Action2 \\r\\n| extend SourcePort = tostring(SourcePortInt),TargetPort = tostring(TargetPortInt) \\r\\n| extend Action = case(Action1a == \\\"\\\", \\r\\ncase(Action1b == \\\"\\\",Action2,Action1b), Action1a),Protocol = case(Protocol == \\\"\\\", \\r\\nProtocol2, Protocol),SourceIP = case(SourceIP == \\\"\\\", SourceIP2, SourceIP),\\r\\nTargetIP = case(TargetIP == \\\"\\\", TargetIP2, TargetIP),\\r\\nSourcePort = case(SourcePort == \\\"\\\", \\\"N/A\\\", SourcePort),\\r\\nTargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort), \\r\\nNatDestination = case(NatDestination == \\\"\\\", \\r\\n\\\"N/A\\\", NatDestination)  \\r\\n| summarize AMOUNT=count() by TargetPort, SourceIP\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Target ports, by Source IP\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"gridSettings\": {           \"filter\": true,           \"labelSettings\": []         }       },       \"customWidth\": \"33\",       \"name\": \"query - 11\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics \\r\\n| where Category == \\\"AzureFirewallNetworkRule\\\" \\r\\n| parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt:int \\\" to \\\" TargetIP \\\":\\\" TargetPortInt:int * \\r\\n| parse msg_s with * \\\". Action: \\\" Action1a \\r\\n| parse msg_s with * \\\"was \\\" Action1b \\\" to \\\" NatDestination\\r\\n| parse msg_s with Protocol2 \\\" request from \\\" SourceIP2 \\\" to \\\" TargetIP2 \\\". Action:\\\" Action2 \\r\\n| extend SourcePort = tostring(SourcePortInt),TargetPort = tostring(TargetPortInt) \\r\\n| extend Action = case(Action1a == \\\"\\\", \\r\\ncase(Action1b == \\\"\\\",Action2,Action1b), Action1a),\\r\\nProtocol = case(Protocol == \\\"\\\", Protocol2, Protocol),\\r\\nSourceIP = case(SourceIP == \\\"\\\", SourceIP2, SourceIP),\\r\\nTargetIP = case(TargetIP == \\\"\\\", TargetIP2, TargetIP),\\r\\nSourcePort = case(SourcePort == \\\"\\\", \\\"N/A\\\", SourcePort),\\r\\nTargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort),\\r\\nNatDestination = case(NatDestination == \\\"\\\", \\\"N/A\\\", NatDestination)  \\r\\n| where Action == \\\"DNAT'ed\\\"\\r\\n| summarize Amount=count() by NatDestination, TimeGenerated\\r\\n\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"DNAT'ed over time\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"timechart\"       },       \"customWidth\": \"33\",       \"name\": \"query - 13\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where Category == \\\"AzureFirewallNetworkRule\\\"\\r\\n| parse msg_s with Protocol \\\" request from\\\" SourceIP \\\":\\\" SourcePortInt:int \\\" to\\\" TargetIP \\\":\\\" TargetPortInt:int *\\r\\n| parse msg_s with * \\\". Action: \\\" Action1a\\r\\n| parse msg_s with * \\\" was \\\" Action1b \\\" to \\\" NatDestination\\r\\n| parse msg_s with Protocol2 \\\" request from\\\" SourceIP2 \\\" to\\\" TargetIP2 \\\". Action:\\\" Action2\\r\\n| extend SourcePort = tostring(SourcePortInt),TargetPort = tostring(TargetPortInt)\\r\\n| extend Action = case(Action1a == \\\"\\\", case(Action1b == \\\"\\\",Action2,Action1b), Action1a),Protocol = case(Protocol == \\\"\\\", Protocol2, Protocol),SourceIP = case(SourceIP == \\\"\\\", SourceIP2, SourceIP),TargetIP = case(TargetIP == \\\"\\\", TargetIP2, TargetIP),SourcePort = case(SourcePort == \\\"\\\", \\\"N/A\\\", SourcePort),TargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort),NatDestination = case(NatDestination == \\\"\\\", \\\"N/A\\\", NatDestination)\\r\\n| summarize count() by Action, bin(TimeGenerated, {TimeRange:grain})\\r\\n\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Actions, by time\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"timechart\"       },       \"name\": \"query - 15\"     }   ],   \"styleSettings\": {},   \"fromTemplateId\": \"sentinel-AzureFirewall\",   \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\" }",
                                             "category":  "workbook",
                                             "version":  "1.0",
                                             "sourceId":  "[resourceid('Microsoft.OperationalInsights/workspaces',parameters('workspacename'))]"
                                         },
                          "type":  "microsoft.insights/workbooks",
                          "kind":  "shared",
                          "apiVersion":  "2018-06-17-preview",
                          "location":  "[parameters('location')]"
                      },
                      {
                          "name":  "[parameters('security - WebApplicationFirewallFirewallEvents_id')]",
                          "properties":  {
                                             "displayName":  "security - WAF Firewall Events",
                                             "serializedData":  "{   \"version\": \"Notebook/1.0\",   \"items\": [     {       \"type\": 1,       \"content\": {         \"json\": \"## Application gateway firewall events\"       },       \"name\": \"text - 10\"     },     {       \"type\": 9,       \"content\": {         \"version\": \"KqlParameterItem/1.0\",         \"query\": \"\",         \"crossComponentResources\": [],         \"parameters\": [           {             \"id\": \"49e2f511-592f-4d7f-8fda-d686803f3dbf\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"TimeRange\",             \"type\": 4,             \"isRequired\": true,             \"value\": {               \"durationMs\": 2592000000             },             \"typeSettings\": {               \"selectableValues\": [                 {                   \"durationMs\": 300000                 },                 {                   \"durationMs\": 900000                 },                 {                   \"durationMs\": 1800000                 },                 {                   \"durationMs\": 3600000                 },                 {                   \"durationMs\": 14400000                 },                 {                   \"durationMs\": 43200000                 },                 {                   \"durationMs\": 86400000                 },                 {                   \"durationMs\": 172800000                 },                 {                   \"durationMs\": 259200000                 },                 {                   \"durationMs\": 604800000                 },                 {                   \"durationMs\": 1209600000                 },                 {                   \"durationMs\": 2419200000                 },                 {                   \"durationMs\": 2592000000                 },                 {                   \"durationMs\": 5184000000                 },                 {                   \"durationMs\": 7776000000                 }               ],               \"allowCustom\": true             }           },           {             \"id\": \"d54c1639-d46c-4655-9d76-d5416926a453\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"WAF\",             \"type\": 2,             \"isRequired\": true,             \"multiSelect\": true,             \"quote\": \"'\",             \"delimiter\": \",\",             \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| summarize Count=count() by Resource\\r\\n| order by Count desc, Resource asc\\r\\n| project Value = Resource, Lable = strcat(Resource, \\\" - \\\", Count)\",             \"value\": [               \"value::all\"             ],             \"typeSettings\": {               \"additionalResourceOptions\": [                 \"value::all\"               ],               \"selectAllValue\": \"All\"             },             \"queryType\": 0,             \"resourceType\": \"microsoft.operationalinsights/workspaces\"           }         ],         \"style\": \"pills\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\"       },       \"name\": \"parameters - 2\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\" and (\\\"{WAF:lable}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where OperationName == \\\"ApplicationGatewayFirewall\\\"\\r\\n| where action_s == \\\"Blocked\\\" or action_s == \\\"Detected\\\" \\r\\n| summarize count() by requestUri_s \\r\\n| top 10 by count_ desc \",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Blocked URL addresses\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"piechart\"       },       \"customWidth\": \"30\",       \"name\": \"query - 9\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\" and (\\\"{WAF:lable}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where OperationName == \\\"ApplicationGatewayFirewall\\\"\\r\\n| summarize number = count() by action_s\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"WAF actions\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"piechart\"       },       \"customWidth\": \"30\",       \"name\": \"query - 11\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where  (\\\"{WAF:lable}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where OperationName == \\\"ApplicationGatewayFirewall\\\" \\r\\n| summarize number = count() by instanceId_s, TimeGenerated\\r\\n| where instanceId_s contains \\\"role\\\"\\r\\n| extend roulenumber = extract(\\\"ApplicationGateway([a-zA-Z_a-zA-Z_0-9]*)\\\", 1, instanceId_s) \\r\\n| project roulenumber , number , TimeGenerated \\r\\n\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Role use, by time\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"linechart\"       },       \"customWidth\": \"40\",       \"name\": \"query - 8\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where \\\"{WAF:lable}\\\" == \\\"All\\\" or Resource in ({WAF})\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where OperationName == \\\"ApplicationGatewayFirewall\\\"\\r\\n| summarize count() by Message\\r\\n| top 10 by count_ \\r\\n\",         \"size\": 0,         \"exportFieldName\": \"Message\",         \"exportParameterName\": \"Selected\",         \"exportDefaultValue\": \"*\",         \"exportToExcelOptions\": \"visible\",         \"title\": \"Event trigger\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"table\",         \"gridSettings\": {           \"formatters\": [             {               \"columnMatch\": \"Message\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"count_\",               \"formatter\": 3,               \"formatOptions\": {                 \"palette\": \"blue\",                 \"showIcon\": true               }             }           ],           \"labelSettings\": [             {               \"columnId\": \"Message\"             },             {               \"columnId\": \"count_\",               \"label\": \"\"             }           ]         }       },       \"customWidth\": \"50\",       \"name\": \"query - 12\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where \\\"{WAF:lable}\\\" == \\\"All\\\" or Resource in ({WAF})\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where OperationName == \\\"ApplicationGatewayFirewall\\\"\\r\\n| where ('{Selected}' == Message) or '{Selected}'==\\\"*\\\"\\r\\n| summarize count() by Message, TimeGenerated\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Messages, by time\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"barchart\",         \"tileSettings\": {           \"showBorder\": false,           \"titleContent\": {             \"columnMatch\": \"Message\",             \"formatter\": 1           },           \"leftContent\": {             \"columnMatch\": \"count_\",             \"formatter\": 12,             \"formatOptions\": {               \"palette\": \"auto\"             },             \"numberFormat\": {               \"unit\": 17,               \"options\": {                 \"maximumSignificantDigits\": 3,                 \"maximumFractionDigits\": 2               }             }           }         }       },       \"customWidth\": \"50\",       \"name\": \"query - 13\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where \\\"{WAF:lable}\\\" == \\\"All\\\" or Resource in ({WAF})\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where OperationName == \\\"ApplicationGatewayFirewall\\\"\\r\\n| where '{Selected}' == Message or '{Selected}' == \\\"*\\\"\\r\\n| extend Role =  extract(\\\"ApplicationGateway([a-zA-Z_a-zA-Z_0-9]*)\\\",1,instanceId_s) \\r\\n| project Message, TimeGenerated, SourceSystem, hostname_s, ResourceId, ResourceGroup, ResourceProvider, Category, Role, action_s, site_s, details_message_s, details_file_s, clientIp_s, requestUri_s\\r\\n| sort by TimeGenerated\\r\\n\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Message, full details\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"table\"       },       \"name\": \"query - 11\"     },     {       \"type\": 1,       \"content\": {         \"json\": \"---\"       },       \"name\": \"text - 12\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\" and (\\\"{WAF:lable}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where OperationName == \\\"ApplicationGatewayFirewall\\\"\\r\\n| where Message contains \\\"attack\\\"\\r\\n| extend Role =  extract(\\\"ApplicationGateway([a-zA-Z_a-zA-Z_0-9]*)\\\",1,instanceId_s) \\r\\n| summarize Amount = count() by Message, bin(TimeGenerated, 1h), hostName = hostname_s, ResourceId, Category, Role\\r\\n| project Amount, Message, TimeGenerated, hostName, ResourceId, Category, Role\\r\\n| order by Amount desc\",         \"size\": 0,         \"exportFieldName\": \"\",         \"exportParameterName\": \"MessageFilter\",         \"exportDefaultValue\": \"{\\\"Message\\\":\\\"*\\\"}\",         \"exportToExcelOptions\": \"visible\",         \"title\": \"Attacks events, by messages\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"gridSettings\": {           \"formatters\": [             {               \"columnMatch\": \"Amount\",               \"formatter\": 8,               \"formatOptions\": {                 \"showIcon\": true,                 \"aggregation\": \"Sum\"               }             },             {               \"columnMatch\": \"Message\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"TimeGenerated\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"hostName\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"ResourceId\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"Category\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"Role\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"$gen_group\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"Count\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"TenantId\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"SourceSystem\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"MG\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"ManagementGroupName\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"Computer\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"ruleGroup_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"transactionId_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"originalHost_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"_schema_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"error_code_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"error_message_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"instanceId_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"clientIp_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"clientPort_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"requestUri_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"ruleSetType_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"ruleSetVersion_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"ruleId_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"action_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"site_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"details_message_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"details_data_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"details_file_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"details_line_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"hostname_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"clientIP_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"clientPort_d\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"httpMethod_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"requestQuery_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"userAgent_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"httpStatus_d\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"httpVersion_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"receivedBytes_d\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"sentBytes_d\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"timeTaken_d\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"sslEnabled_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"host_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"correlation_clientTrackingId_g\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"tags__type_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"msg_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"resource_originRunId_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"resource_actionName_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"correlation_actionTrackingId_g\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"workflowId_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"Level\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"OperationName\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"status_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"tags_LogicAppsCategory_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"resource_resourceGroupName_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"resource_workflowName_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"resource_runId_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"resource_location_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"resource_triggerName_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"SubscriptionId\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"ResourceGroup\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"ResourceProvider\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"Resource\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"ResourceType\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"code_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"correlation_clientTrackingId_s\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"resource_subscriptionId_g\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"resource_workflowId_g\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"startTime_t\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"endTime_t\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"Type\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"_ResourceId\",               \"formatter\": 0,               \"formatOptions\": {                 \"showIcon\": true               }             }           ],           \"filter\": true,           \"hierarchySettings\": {             \"treeType\": 1,             \"groupBy\": [               \"Message\"             ],             \"expandTopLevel\": false           },           \"labelSettings\": []         }       },       \"name\": \"query - 16\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let SelectedMS = dynamic({MessageFilter}); // reference to the above list of messages (Event trigger)\\r\\nlet Child = SelectedMS.childRows; // Used to choose a group of messages - redirects to the message which was grouped\\r\\nAzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\" and (\\\"{WAF:lable}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where OperationName == \\\"ApplicationGatewayFirewall\\\"\\r\\n| where Message contains \\\"attack\\\"\\r\\n| where SelectedMS.Message == Message or SelectedMS.Message == \\\"*\\\" or Message == Child[0].Message\\r\\n| summarize count() by Message, TimeGenerated\",         \"size\": 0,         \"exportParameterName\": \"Message\",         \"exportDefaultValue\": \"{ \\\"Name\\\":\\\"\\\", \\\"Type\\\":\\\"*\\\"}\",         \"exportToExcelOptions\": \"visible\",         \"title\": \"Attack events, by time\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"barchart\"       },       \"customWidth\": \"70\",       \"name\": \"query - 14\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\" and (\\\"{WAF:lable}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where Message contains \\\"SQL Injection\\\" \\r\\n| summarize count() by hostname_s, Message\\r\\n| order by count_ desc \",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"SQL injection, by host name\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\"       },       \"customWidth\": \"30\",       \"name\": \"query - 15\"     }   ],   \"styleSettings\": {},   \"fromTemplateId\": \"sentinel-WebApplicationFirewallFirewallEvents\",   \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\" }",
                                             "category":  "workbook",
                                             "version":  "1.0",
                                             "sourceId":  "[resourceid('Microsoft.OperationalInsights/workspaces',parameters('workspacename'))]"
                                         },
                          "type":  "microsoft.insights/workbooks",
                          "kind":  "shared",
                          "apiVersion":  "2018-06-17-preview",
                          "location":  "[parameters('location')]"
                      },
                      {
                          "name":  "[parameters('security - WebApplicationFirewallGatewayAccessEvents_id')]",
                          "properties":  {
                                             "displayName":  "security - WAF Gateway Access Events",
                                             "serializedData":  "{   \"version\": \"Notebook/1.0\",   \"items\": [     {       \"type\": 1,       \"content\": {         \"json\": \"## Application gateway access events\\n\"       },       \"customWidth\": \"100\",       \"name\": \"text - 2\"     },     {       \"type\": 9,       \"content\": {         \"version\": \"KqlParameterItem/1.0\",         \"parameters\": [           {             \"id\": \"b3ac8870-500d-4dd8-a570-f49a2c2f1a76\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"TimeRange\",             \"type\": 4,             \"isRequired\": true,             \"value\": {               \"durationMs\": 86400000             },             \"typeSettings\": {               \"selectableValues\": [                 {                   \"durationMs\": 300000                 },                 {                   \"durationMs\": 900000                 },                 {                   \"durationMs\": 1800000                 },                 {                   \"durationMs\": 3600000                 },                 {                   \"durationMs\": 14400000                 },                 {                   \"durationMs\": 43200000                 },                 {                   \"durationMs\": 86400000                 },                 {                   \"durationMs\": 172800000                 },                 {                   \"durationMs\": 259200000                 },                 {                   \"durationMs\": 604800000                 },                 {                   \"durationMs\": 1209600000                 },                 {                   \"durationMs\": 2419200000                 },                 {                   \"durationMs\": 2592000000                 },                 {                   \"durationMs\": 5184000000                 },                 {                   \"durationMs\": 7776000000                 }               ],               \"allowCustom\": true             }           }         ],         \"style\": \"pills\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\"       },       \"customWidth\": \"50\",       \"name\": \"parameters - 2\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let ActivityData = AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where OperationName == \\\"ApplicationGatewayAccess\\\";\\r\\nActivityData\\r\\n| summarize Count = count() by clientIP_s\\r\\n| join kind = inner (ActivityData\\r\\n | make-series Trend = count() default = 0 on bin(TimeGenerated, 1d) from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by clientIP_s)\\r\\n on clientIP_s\\r\\n | project-away clientIP_s1, TimeGenerated\\r\\n| extend clientIP = clientIP_s\\r\\n| union (\\r\\n ActivityData\\r\\n | summarize Count = count() \\r\\n | extend jkey = 1\\r\\n | join kind=inner (ActivityData\\r\\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\\r\\n | extend jkey = 1) on jkey\\r\\n | extend clientIP_s = 'All Clients', clientIP_ = '*' \\r\\n)\\r\\n| order by Count desc\\r\\n| take 10\",         \"size\": 4,         \"title\": \"Top 10 IP's by activity\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"tiles\",         \"tileSettings\": {           \"titleContent\": {             \"columnMatch\": \"clientIp_s\",             \"formatter\": 1           },           \"leftContent\": {             \"columnMatch\": \"Count\",             \"formatter\": 12,             \"formatOptions\": {               \"palette\": \"auto\"             },             \"numberFormat\": {               \"unit\": 17,               \"options\": {                 \"style\": \"decimal\",                 \"useGrouping\": false,                 \"maximumFractionDigits\": 2,                 \"maximumSignificantDigits\": 3               }             }           },           \"rightContent\": {             \"columnMatch\": \"clientIP_s\"           },           \"secondaryContent\": {             \"columnMatch\": \"Trend\",             \"formatter\": 9           },           \"showBorder\": false         }       },       \"name\": \"query - 2\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where OperationName == \\\"ApplicationGatewayAccess\\\"\\r\\n| summarize Count= count() by clientIP_s, bin(TimeGenerated, 1d)\\r\\n\",         \"size\": 0,         \"title\": \"Activity, by cIient IP address\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"timechart\"       },       \"customWidth\": \"70\",       \"name\": \"query - 3\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where OperationName == \\\"ApplicationGatewayAccess\\\"\\r\\n| summarize count() by clientIP_s, TimeGenerated\\r\\n\",         \"size\": 0,         \"title\": \"SSL use\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"piechart\"       },       \"customWidth\": \"30\",       \"name\": \"query - 4\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where OperationName == \\\"ApplicationGatewayAccess\\\" \\r\\n| summarize receivedBytes = sum(receivedBytes_d)/1048576, sentBytes = sum(sentBytes_d)/1048576  by bin(TimeGenerated, 1d)\\r\\n//| project receivedBytes_d, sentBytes_d, TimeGenerated \\r\\n\",         \"size\": 0,         \"title\": \"Received and sent data, by time\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"timechart\"       },       \"customWidth\": \"70\",       \"name\": \"query - 5\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where OperationName == \\\"ApplicationGatewayAccess\\\" \\r\\n| summarize number = count() by userAgent_s\\r\\n| top 10 by number desc nulls last \\r\\n\",         \"size\": 0,         \"title\": \"User agent use\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"piechart\"       },       \"customWidth\": \"30\",       \"name\": \"query - 6\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where OperationName == \\\"ApplicationGatewayAccess\\\"\\r\\n| summarize number= count() by requestURI=requestUri_s, originalHost=originalHost_s, clientIP=clientIP_s\\r\\n| order by number desc\",         \"size\": 0,         \"title\": \"URL address use, by client IP address\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"gridSettings\": {           \"formatters\": [             {               \"columnMatch\": \"number\",               \"formatter\": 4,               \"formatOptions\": {                 \"min\": 0,                 \"palette\": \"blue\",                 \"showIcon\": true               }             }           ],           \"filter\": true         }       },       \"customWidth\": \"30\",       \"name\": \"query - 7\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where OperationName == \\\"ApplicationGatewayAccess\\\" \\r\\n| summarize Count = count() by httpMethod=httpMethod_s\\r\\n| sort by Count desc\\r\\n\",         \"size\": 0,         \"title\": \"HTTP Methods\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"table\",         \"gridSettings\": {           \"formatters\": [             {               \"columnMatch\": \"Count\",               \"formatter\": 4,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"number\",               \"formatter\": 4,               \"formatOptions\": {                 \"min\": 0,                 \"palette\": \"purple\",                 \"showIcon\": true               }             }           ],           \"filter\": true         }       },       \"customWidth\": \"35\",       \"name\": \"query - 8\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where OperationName == \\\"ApplicationGatewayAccess\\\"\\r\\n| summarize Count = count() by requestQuery=requestQuery_s\\r\\n| sort by Count desc\",         \"size\": 0,         \"title\": \"Request queries\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"table\",         \"gridSettings\": {           \"formatters\": [             {               \"columnMatch\": \"Count\",               \"formatter\": 4,               \"formatOptions\": {                 \"showIcon\": true               }             },             {               \"columnMatch\": \"count_\",               \"formatter\": 4,               \"formatOptions\": {                 \"min\": 0,                 \"palette\": \"turquoise\",                 \"showIcon\": true               }             }           ],           \"filter\": true         }       },       \"customWidth\": \"35\",       \"name\": \"query - 9\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where OperationName == \\\"ApplicationGatewayAccess\\\"\\r\\n| summarize sentBytes = sum(sentBytes_d), recBytes= sum(receivedBytes_d), Count = count() by originalHost=originalHost_s ,clientIP=clientIP_s, requestURI=requestUri_s, httpMethod=httpMethod_s, requestQuery=requestQuery_s, userAgent=userAgent_s, httpVersion=httpVersion_s, httpStatus=httpStatus_d,sslEnabled=sslEnabled_s, bin(TimeGenerated, 1d)\\r\\n| order by sentBytes, recBytes\",         \"size\": 0,         \"title\": \"Detailed activity\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"gridSettings\": {           \"formatters\": [             {               \"columnMatch\": \"sentB\",               \"formatter\": 4,               \"formatOptions\": {                 \"min\": 0,                 \"palette\": \"coldHot\",                 \"showIcon\": true               }             },             {               \"columnMatch\": \"recB\",               \"formatter\": 4,               \"formatOptions\": {                 \"min\": 0,                 \"palette\": \"coldHot\",                 \"showIcon\": true               }             },             {               \"columnMatch\": \"sentb\",               \"formatter\": 4,               \"formatOptions\": {                 \"min\": 0,                 \"palette\": \"coldHot\",                 \"showIcon\": true               }             }           ],           \"rowLimit\": 1000,           \"filter\": true         }       },       \"name\": \"query - 10\"     }   ],   \"fromTemplateId\": \"sentinel-WebApplicationFirewallGatewayAccessEvents\",   \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\" }",
                                             "category":  "workbook",
                                             "version":  "1.0",
                                             "sourceId":  "[resourceid('Microsoft.OperationalInsights/workspaces',parameters('workspacename'))]"
                                         },
                          "type":  "microsoft.insights/workbooks",
                          "kind":  "shared",
                          "apiVersion":  "2018-06-17-preview",
                          "location":  "[parameters('location')]"
                      },
                      {
                          "name":  "[parameters('security - WebApplicationFirewallOverview_id')]",
                          "properties":  {
                                             "displayName":  "security - WAF Overview",
                                             "serializedData":  "{   \"version\": \"Notebook/1.0\",   \"items\": [     {       \"type\": 9,       \"content\": {         \"version\": \"KqlParameterItem/1.0\",         \"query\": \"\",         \"crossComponentResources\": [],         \"parameters\": [           {             \"id\": \"49e2f511-592f-4d7f-8fda-d686803f3dbf\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"TimeRange\",             \"type\": 4,             \"isRequired\": true,             \"value\": {               \"durationMs\": 2592000000             },             \"typeSettings\": {               \"selectableValues\": [                 {                   \"durationMs\": 300000                 },                 {                   \"durationMs\": 900000                 },                 {                   \"durationMs\": 1800000                 },                 {                   \"durationMs\": 3600000                 },                 {                   \"durationMs\": 14400000                 },                 {                   \"durationMs\": 43200000                 },                 {                   \"durationMs\": 86400000                 },                 {                   \"durationMs\": 172800000                 },                 {                   \"durationMs\": 259200000                 },                 {                   \"durationMs\": 604800000                 },                 {                   \"durationMs\": 1209600000                 },                 {                   \"durationMs\": 2419200000                 },                 {                   \"durationMs\": 2592000000                 },                 {                   \"durationMs\": 5184000000                 },                 {                   \"durationMs\": 7776000000                 }               ],               \"allowCustom\": true             }           },           {             \"id\": \"d54c1639-d46c-4655-9d76-d5416926a453\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"WAF\",             \"type\": 2,             \"isRequired\": true,             \"multiSelect\": true,             \"quote\": \"'\",             \"delimiter\": \",\",             \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| summarize Count=count() by Resource\\r\\n| order by Count desc, Resource asc\\r\\n| project Value = Resource, Lable = strcat(Resource, \\\" - \\\", Count)\",             \"value\": null,             \"typeSettings\": {               \"additionalResourceOptions\": [                 \"value::all\"               ],               \"selectAllValue\": \"All\"             },             \"queryType\": 0,             \"resourceType\": \"microsoft.operationalinsights/workspaces\"           },           {             \"id\": \"b1a1c99d-4498-4e02-82f0-d52c276d5657\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"Events\",             \"type\": 2,             \"isRequired\": true,             \"multiSelect\": true,             \"quote\": \"'\",             \"delimiter\": \",\",             \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| summarize Count = count() by OperationName\\r\\n| order by Count desc, OperationName asc\\r\\n| project value = OperationName, Label = strcat(OperationName, ' - ', Count)\",             \"value\": null,             \"typeSettings\": {               \"additionalResourceOptions\": [                 \"value::all\"               ],               \"selectAllValue\": \"All\"             },             \"queryType\": 0,             \"resourceType\": \"microsoft.operationalinsights/workspaces\"           }         ],         \"style\": \"pills\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\"       },       \"name\": \"parameters - 2\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\" \\n| where \\\"{WAF:lable}\\\"==\\\"All\\\" or Resource in ({WAF})\\n| where \\\"{Events:lable}\\\"==\\\"All\\\" or OperationName in ({Events})\\n| summarize count() by Resource, TimeGenerated\",         \"size\": 1,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Resource events, by time\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"linechart\",         \"tileSettings\": {           \"showBorder\": false,           \"titleContent\": {             \"columnMatch\": \"Resource\",             \"formatter\": 1           },           \"leftContent\": {             \"columnMatch\": \"count_\",             \"formatter\": 12,             \"formatOptions\": {               \"palette\": \"auto\"             },             \"numberFormat\": {               \"unit\": 17,               \"options\": {                 \"maximumSignificantDigits\": 3,                 \"maximumFractionDigits\": 2               }             }           }         }       },       \"customWidth\": \"70\",       \"name\": \"query - 2\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\"\\r\\n| where \\\"{WAF:lable}\\\"==\\\"All\\\" or Resource in ({WAF})\\r\\n| where \\\"{Events:lable}\\\"==\\\"All\\\" or OperationName in ({Events})\\r\\n| summarize number = count() by Resource\\r\\n\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Resource use\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"piechart\"       },       \"customWidth\": \"30\",       \"name\": \"query - 4\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\" \\r\\n| where \\\"{WAF:lable}\\\"==\\\"All\\\" or Resource in ({WAF})\\r\\n| where \\\"{Events:lable}\\\"==\\\"All\\\" or OperationName in ({Events})\\r\\n| summarize number = count() by OperationName, TimeGenerated\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Firewall and access events, by time\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"timechart\"       },       \"customWidth\": \"70\",       \"name\": \"query - 5\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\" \\r\\n| where \\\"{WAF:lable}\\\"==\\\"All\\\" or Resource in ({WAF})\\r\\n| where \\\"{Events:lable}\\\"==\\\"All\\\" or OperationName in ({Events})\\r\\n| summarize number = count() by OperationName\",         \"size\": 0,         \"exportToExcelOptions\": \"visible\",         \"title\": \"Events, by operation\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"TimeRange\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"piechart\"       },       \"customWidth\": \"30\",       \"name\": \"query - 6\"     }   ],   \"styleSettings\": {},   \"fromTemplateId\": \"sentinel-WebApplicationFirewallOverview\",   \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\" }",
                                             "category":  "workbook",
                                             "version":  "1.0",
                                             "sourceId":  "[resourceid('Microsoft.OperationalInsights/workspaces',parameters('workspacename'))]"
                                         },
                          "type":  "microsoft.insights/workbooks",
                          "kind":  "shared",
                          "apiVersion":  "2018-06-17-preview",
                          "location":  "[parameters('location')]"
                      },
                      {
                          "name":  "[parameters('security - WebApplicationFirewallWAFTypeEvents_id')]",
                          "properties":  {
                                             "displayName":  "security - WAF Type Events",
                                             "serializedData":  "{   \"version\": \"Notebook/1.0\",   \"items\": [     {       \"type\": 1,       \"content\": {         \"json\": \"## Azure WAF Events\"       },       \"name\": \"text - 10\"     },     {       \"type\": 9,       \"content\": {         \"version\": \"KqlParameterItem/1.0\",         \"crossComponentResources\": [           \"{Subscription}\"         ],         \"parameters\": [           {             \"id\": \"afd56a69-16a5-436d-850e-16c24e839503\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"DefaultSubscription_Internal\",             \"type\": 1,             \"isRequired\": true,             \"query\": \"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| take 1\\r\\n| project subscriptionId\",             \"crossComponentResources\": [               \"value::all\"             ],             \"isHiddenWhenLocked\": true,             \"queryType\": 1,             \"resourceType\": \"microsoft.resourcegraph/resources\"           },           {             \"id\": \"e38cad87-ff16-40e6-9384-f6fd24fa9d6b\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"Subscription\",             \"type\": 6,             \"isRequired\": true,             \"multiSelect\": true,             \"quote\": \"'\",             \"delimiter\": \",\",             \"query\": \"summarize by subscriptionId\\r\\n| project value=strcat(\\\"/subscriptions/\\\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{DefaultSubscription_Internal}', true, false)\",             \"crossComponentResources\": [               \"value::all\"             ],             \"value\": [               \"/subscriptions/6b1ceacd-5731-4780-8f96-2078dd96fd96\"             ],             \"typeSettings\": {               \"additionalResourceOptions\": [                 \"value::all\"               ],               \"showDefault\": false             },             \"timeContextFromParameter\": \"TimeRange\",             \"queryType\": 1,             \"resourceType\": \"microsoft.resourcegraph/resources\"           },           {             \"id\": \"a125fc08-be6d-4b8b-87e2-7e0cd957db47\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"DefaultWorkspace_Internal\",             \"type\": 1,             \"isRequired\": true,             \"query\": \"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n|take 1\\r\\n|project id\",             \"crossComponentResources\": [               \"{Subscription}\"             ],             \"isHiddenWhenLocked\": true,             \"timeContextFromParameter\": \"TimeRange\",             \"queryType\": 1,             \"resourceType\": \"microsoft.resourcegraph/resources\"           },           {             \"id\": \"65674a40-2869-4867-a24d-f86f05fd0354\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"Workspaces\",             \"type\": 5,             \"isRequired\": true,             \"multiSelect\": true,             \"quote\": \"'\",             \"delimiter\": \",\",             \"query\": \"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| project id, selected = iff(id =~ '{DefaultWorkspace_Internal}', true, false)\\r\\n\",             \"crossComponentResources\": [               \"{Subscription}\"             ],             \"value\": [               \"/subscriptions/6b1ceacd-5731-4780-8f96-2078dd96fd96/resourceGroups/SOC-NS/providers/Microsoft.OperationalInsights/workspaces/SOC-NS-Logs\"             ],             \"typeSettings\": {               \"additionalResourceOptions\": [                 \"value::all\"               ],               \"showDefault\": false             },             \"timeContextFromParameter\": \"TimeRange\",             \"queryType\": 1,             \"resourceType\": \"microsoft.resourcegraph/resources\"           },           {             \"id\": \"49e2f511-592f-4d7f-8fda-d686803f3dbf\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"TimeRange\",             \"label\": \"Time Range\",             \"type\": 4,             \"isRequired\": true,             \"value\": {               \"durationMs\": 86400000             },             \"typeSettings\": {               \"selectableValues\": [                 {                   \"durationMs\": 300000                 },                 {                   \"durationMs\": 900000                 },                 {                   \"durationMs\": 1800000                 },                 {                   \"durationMs\": 3600000                 },                 {                   \"durationMs\": 14400000                 },                 {                   \"durationMs\": 43200000                 },                 {                   \"durationMs\": 86400000                 }               ],               \"allowCustom\": true             }           },           {             \"id\": \"604a42a0-deca-4a95-a15f-8977646a7fac\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"WAFType\",             \"type\": 5,             \"isRequired\": true,             \"multiSelect\": true,             \"quote\": \"'\",             \"delimiter\": \",\",             \"query\": \"let FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nFakeData | union AzureDiagnostics\\r\\n| where ResourceType == \\\"APPLICATIONGATEWAYS\\\" or ResourceType == \\\"FRONTDOORS\\\" or ResourceType == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\"\\r\\n| summarize Count=count() by ResourceType\\r\\n| extend ResourceTypeImproved = iif(ResourceType == \\\"APPLICATIONGATEWAYS\\\", \\\"Application Gateway\\\", ResourceType)\\r\\n| extend ResourceTypeImproved = iif(ResourceTypeImproved == \\\"FRONTDOORS\\\", \\\"Azure Front Door\\\", ResourceTypeImproved)\\r\\n| extend ResourceTypeImproved = iif(ResourceTypeImproved == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\", \\\"Azure CDN\\\", ResourceTypeImproved)\\r\\n| order by Count desc, ResourceTypeImproved asc\\r\\n| project ResourceTypeImproved\",             \"crossComponentResources\": [               \"{Workspaces}\"             ],             \"value\": [               \"value::all\"             ],             \"typeSettings\": {               \"additionalResourceOptions\": [                 \"value::all\"               ]             },             \"timeContext\": {               \"durationMs\": 0             },             \"timeContextFromParameter\": \"TimeRange\",             \"queryType\": 0,             \"resourceType\": \"microsoft.operationalinsights/workspaces\",             \"label\": \"WAF Type\"           },           {             \"id\": \"d54c1639-d46c-4655-9d76-d5416926a453\",             \"version\": \"KqlParameterItem/1.0\",             \"name\": \"WAF\",             \"label\": \"WAF Items\",             \"type\": 2,             \"isRequired\": true,             \"multiSelect\": true,             \"quote\": \"'\",             \"delimiter\": \",\",             \"query\": \"let FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nFakeData | union AzureDiagnostics\\r\\n| where (ResourceType == \\\"APPLICATIONGATEWAYS\\\" or ResourceType == \\\"FRONTDOORS\\\" or ResourceType == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\") and (\\\"{WAFType:label}\\\" == \\\"All\\\" or (ResourceType == \\\"APPLICATIONGATEWAYS\\\" and \\\"{WAFType:label}\\\" contains \\\"application gateway\\\") or (ResourceType == \\\"FRONTDOORS\\\" and  \\\"{WAFType:label}\\\" contains \\\"azure front door\\\") or (ResourceType==\\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\" and \\\"{WAFType:label}\\\" contains \\\"cdn\\\"))\\r\\n| summarize Count=count() by Resource\\r\\n| order by Count desc, Resource asc\\r\\n| project Value = Resource, Label = strcat(Resource, \\\" - \\\", Count)\",             \"crossComponentResources\": [               \"{Workspaces}\"             ],             \"value\": [               \"value::all\"             ],             \"typeSettings\": {               \"additionalResourceOptions\": [                 \"value::all\"               ]             },             \"timeContext\": {               \"durationMs\": 0             },             \"timeContextFromParameter\": \"TimeRange\",             \"queryType\": 0,             \"resourceType\": \"microsoft.operationalinsights/workspaces\"           }         ],         \"style\": \"pills\",         \"queryType\": 1,         \"resourceType\": \"microsoft.resourcegraph/resources\"       },       \"name\": \"parameters - 2\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nFakeData | union AzureDiagnostics\\r\\n| where (ResourceType == \\\"APPLICATIONGATEWAYS\\\" or ResourceType == \\\"FRONTDOORS\\\" or ResourceType == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\") and (\\\"{WAFType:label}\\\" == \\\"All\\\" or (ResourceType == \\\"APPLICATIONGATEWAYS\\\" and \\\"{WAFType:label}\\\" contains \\\"application gateway\\\") or (ResourceType == \\\"FRONTDOORS\\\" and  \\\"{WAFType:label}\\\" contains \\\"azure front door\\\") or (ResourceType==\\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\" and \\\"{WAFType:label}\\\" contains \\\"cdn\\\")) and (\\\"{WAF:label}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where Category == \\\"FrontdoorWebApplicationFirewallLog\\\" or OperationName == \\\"ApplicationGatewayFirewall\\\" or Category == \\\"WebApplicationFirewallLogs\\\"\\r\\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\\r\\n// Application Gateway has Matched, Blocked, Detected : translates to Matched, Block, Log\\r\\n// Azure Front Door has Matched, Block, Log : translates to Matched, Block, Log\\r\\n| extend Action = iif(action_s == \\\"Blocked\\\", Action = \\\"Block\\\", action_s)\\r\\n| extend Action = iif(Action == \\\"Detected\\\", Action = \\\"Log\\\", Action)\\r\\n| summarize number = count() by Action\",         \"size\": 3,         \"showAnalytics\": true,         \"title\": \"WAF actions filter\",         \"timeContext\": {           \"durationMs\": 86400000         },         \"timeContextFromParameter\": \"TimeRange\",         \"exportFieldName\": \"series\",         \"exportParameterName\": \"SelectedAction\",         \"exportDefaultValue\": \"*\",         \"showExportToExcel\": true,         \"exportToExcelOptions\": \"all\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"piechart\"       },       \"customWidth\": \"27\",       \"name\": \"query - 11\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nFakeData | union AzureDiagnostics\\r\\n| where (ResourceType == \\\"APPLICATIONGATEWAYS\\\" or ResourceType == \\\"FRONTDOORS\\\" or ResourceType == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\") and (\\\"{WAFType:label}\\\" == \\\"All\\\" or (ResourceType == \\\"APPLICATIONGATEWAYS\\\" and \\\"{WAFType:label}\\\" contains \\\"application gateway\\\") or (ResourceType == \\\"FRONTDOORS\\\" and  \\\"{WAFType:label}\\\" contains \\\"azure front door\\\") or (ResourceType==\\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\" and \\\"{WAFType:label}\\\" contains \\\"cdn\\\")) and (\\\"{WAF:label}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where Category == \\\"FrontdoorWebApplicationFirewallLog\\\" or OperationName == \\\"ApplicationGatewayFirewall\\\" or Category == \\\"WebApplicationFirewallLogs\\\"\\r\\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\\r\\n| extend Action = iif(action_s == \\\"Blocked\\\", Action = \\\"Block\\\", action_s)\\r\\n| extend Action = iif(Action == \\\"Detected\\\", Action = \\\"Log\\\", Action)\\r\\n| where Action == \\\"Block\\\"\\r\\n| where requestUri_s \u003c\u003e \\\"/\\\"\\r\\n| summarize count() by requestUri_s \\r\\n| top 40 by count_ desc \",         \"size\": 3,         \"showAnalytics\": true,         \"title\": \"Top 40 Blocked Request URI addresses, filter to single URI address\",         \"noDataMessage\": \"The current data has no \\\"Blocked\\\" results\",         \"timeContext\": {           \"durationMs\": 86400000         },         \"timeContextFromParameter\": \"TimeRange\",         \"exportFieldName\": \"requestUri_s\",         \"exportParameterName\": \"RequestURI\",         \"exportDefaultValue\": \"*\",         \"showExportToExcel\": true,         \"exportToExcelOptions\": \"all\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"tiles\",         \"tileSettings\": {           \"titleContent\": {             \"columnMatch\": \"requestUri_s\",             \"formatter\": 1,             \"formatOptions\": {               \"showIcon\": true             }           },           \"leftContent\": {             \"columnMatch\": \"count_\",             \"formatter\": 8,             \"formatOptions\": {               \"palette\": \"auto\",               \"showIcon\": true             },             \"numberFormat\": {               \"unit\": 17,               \"options\": {                 \"style\": \"decimal\",                 \"useGrouping\": false,                 \"maximumFractionDigits\": 2,                 \"maximumSignificantDigits\": 5               }             }           },           \"showBorder\": false         },         \"graphSettings\": {           \"type\": 0,           \"topContent\": {             \"columnMatch\": \"requestUri_s\",             \"formatter\": 1           },           \"centerContent\": {             \"columnMatch\": \"count_\",             \"formatter\": 1,             \"numberFormat\": {               \"unit\": 17,               \"options\": {                 \"maximumSignificantDigits\": 3,                 \"maximumFractionDigits\": 2               }             }           }         },         \"mapSettings\": {           \"locInfo\": \"LatLong\",           \"sizeSettings\": \"count_\",           \"sizeAggregation\": \"Sum\",           \"legendMetric\": \"count_\",           \"legendAggregation\": \"Sum\",           \"itemColorSettings\": {             \"type\": \"heatmap\",             \"colorAggregation\": \"Sum\",             \"nodeColorField\": \"count_\",             \"heatmapPalette\": \"greenRed\"           }         }       },       \"customWidth\": \"63\",       \"name\": \"query - 9\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nFakeData | union AzureDiagnostics\\r\\n| where (ResourceType == \\\"APPLICATIONGATEWAYS\\\" or ResourceType == \\\"FRONTDOORS\\\" or ResourceType == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\") and (\\\"{WAFType:label}\\\" == \\\"All\\\" or (ResourceType == \\\"APPLICATIONGATEWAYS\\\" and \\\"{WAFType:label}\\\" contains \\\"application gateway\\\") or (ResourceType == \\\"FRONTDOORS\\\" and  \\\"{WAFType:label}\\\" contains \\\"azure front door\\\") or (ResourceType==\\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\" and \\\"{WAFType:label}\\\" contains \\\"cdn\\\")) and (\\\"{WAF:label}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where Category == \\\"FrontdoorWebApplicationFirewallLog\\\" or OperationName == \\\"ApplicationGatewayFirewall\\\" or Category == \\\"WebApplicationFirewallLogs\\\"\\r\\n| extend Action = iif(action_s == \\\"Blocked\\\", Action = \\\"Block\\\", action_s)\\r\\n| extend Action = iif(Action == \\\"Detected\\\", Action = \\\"Log\\\", Action)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\" \\r\\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \\\"*\\\"\\r\\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\\r\\n| extend Rule= iif(Rule contains \\\"Mandatory rule. Cannot be disabled.\\\", strcat_array(split(Rule, \\\"Mandatory rule. Cannot be disabled. Inbound \\\",1),\\\"\\\"), Rule) // Removes initial component for mandatory rule \\r\\n| extend Rule = iif(Rule contains \\\"Total Inbound Score\\\", strcat_array(array_concat(split(Rule, \\\" - SQLI=\\\", 0), parse_json('[\\\") -\\\"]'), split(Rule,\\\"):\\\",1)),\\\"\\\"),Rule) // Removes smaller information if more info is available for anomaly score\\r\\n| summarize count() by Rule\\r\\n| top 50 by count_ desc\\r\\n\",         \"size\": 0,         \"showAnalytics\": true,         \"title\": \"Top 50 event trigger, filter by rule name\",         \"timeContext\": {           \"durationMs\": 86400000         },         \"timeContextFromParameter\": \"TimeRange\",         \"exportFieldName\": \"Rule\",         \"exportParameterName\": \"Selected\",         \"exportDefaultValue\": \"*\",         \"showExportToExcel\": true,         \"exportToExcelOptions\": \"all\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"table\",         \"gridSettings\": {           \"formatters\": [             {               \"columnMatch\": \"count_\",               \"formatter\": 3,               \"formatOptions\": {                 \"palette\": \"blue\",                 \"showIcon\": true               }             }           ],           \"sortBy\": [             {               \"itemKey\": \"$gen_bar_count__1\",               \"sortOrder\": 2             }           ],           \"labelSettings\": [             {               \"columnId\": \"count_\",               \"label\": \"\"             }           ]         },         \"sortBy\": [           {             \"itemKey\": \"$gen_bar_count__1\",             \"sortOrder\": 2           }         ]       },       \"customWidth\": \"30\",       \"name\": \"query - 12\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nFakeData | union AzureDiagnostics\\r\\n| where (ResourceType == \\\"APPLICATIONGATEWAYS\\\" or ResourceType == \\\"FRONTDOORS\\\" or ResourceType == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\") and (\\\"{WAFType:label}\\\" == \\\"All\\\" or (ResourceType == \\\"APPLICATIONGATEWAYS\\\" and \\\"{WAFType:label}\\\" contains \\\"application gateway\\\") or (ResourceType == \\\"FRONTDOORS\\\" and  \\\"{WAFType:label}\\\" contains \\\"azure front door\\\") or (ResourceType==\\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\" and \\\"{WAFType:label}\\\" contains \\\"cdn\\\")) and (\\\"{WAF:label}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where Category == \\\"FrontdoorWebApplicationFirewallLog\\\" or OperationName == \\\"ApplicationGatewayFirewall\\\" or Category == \\\"WebApplicationFirewallLogs\\\"\\r\\n| extend Action = iif(action_s == \\\"Blocked\\\", Action = \\\"Block\\\", action_s)\\r\\n| extend Action = iif(Action == \\\"Detected\\\", Action = \\\"Log\\\", Action)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\" \\r\\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \\\"*\\\"\\r\\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\"\\r\\n| summarize count() by Rule, bin(TimeGenerated, 1h)\\r\\n\",         \"size\": 0,         \"showAnalytics\": true,         \"title\": \"Messages, by time\",         \"timeContext\": {           \"durationMs\": 86400000         },         \"timeContextFromParameter\": \"TimeRange\",         \"timeBrushParameterName\": \"timeBrushUpperSection\",         \"showExportToExcel\": true,         \"exportToExcelOptions\": \"all\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"barchart\",         \"tileSettings\": {           \"showBorder\": false,           \"titleContent\": {             \"columnMatch\": \"Message\",             \"formatter\": 1           },           \"leftContent\": {             \"columnMatch\": \"count_\",             \"formatter\": 12,             \"formatOptions\": {               \"palette\": \"auto\"             },             \"numberFormat\": {               \"unit\": 17,               \"options\": {                 \"maximumSignificantDigits\": 3,                 \"maximumFractionDigits\": 2               }             }           }         }       },       \"customWidth\": \"70\",       \"name\": \"query - 13\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let FakeData = (datatable (Message:string,ruleName_s:string,clientIp_s:string,clientIP_s:string,action_s:string,transactionId_s:string,site_s:string,details_message_sRole:string,details_file_sRole:string,hostname_sRole:string,Role:string,trackingReference_s:string,requestUri_s:string,ruleSetType_s:string,details_message_s:string,details_data_s:string,details_file_s:string,hostname_s:string,instanceId_s:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\",\\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\",\\\"\\\",\\\"\\\",\\\"\\\",\\\"\\\",\\\"\\\",\\\"\\\",\\\"\\\" ]);\\r\\nFakeData | union AzureDiagnostics\\r\\n| where (ResourceType == \\\"APPLICATIONGATEWAYS\\\" or ResourceType == \\\"FRONTDOORS\\\" or ResourceType == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\") and (\\\"{WAFType:label}\\\" == \\\"All\\\" or (ResourceType == \\\"APPLICATIONGATEWAYS\\\" and \\\"{WAFType:label}\\\" contains \\\"application gateway\\\") or (ResourceType == \\\"FRONTDOORS\\\" and  \\\"{WAFType:label}\\\" contains \\\"azure front door\\\") or (ResourceType==\\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\" and \\\"{WAFType:label}\\\" contains \\\"cdn\\\")) and (\\\"{WAF:label}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where Category == \\\"FrontdoorWebApplicationFirewallLog\\\" or OperationName == \\\"ApplicationGatewayFirewall\\\" or Category == \\\"WebApplicationFirewallLogs\\\"\\r\\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\\r\\n| extend Action = iif(action_s == \\\"Blocked\\\", Action = \\\"Block\\\", action_s)\\r\\n| extend Action = iif(Action == \\\"Detected\\\", Action = \\\"Log\\\", Action)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\" \\r\\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \\\"*\\\"\\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\" \\r\\n| extend Role =  extract(\\\"ApplicationGateway([a-zA-Z_a-zA-Z_0-9]*)\\\",1,instanceId_s) \\r\\n| extend RequestUri = requestUri_s, RuleSetType = ruleSetType_s, Message_Details = details_message_s, Data_Details = details_data_s, File_Details = details_file_s, Hostname = hostname_s, Site = site_s\\r\\n| project Rule, TimeGenerated, SourceSystem, Hostname, ResourceId, ResourceGroup, ResourceProvider, Category, Role, Action, Site, Message_Details, File_Details, ClientIP, RequestUri\\r\\n| sort by TimeGenerated\",         \"size\": 0,         \"showAnalytics\": true,         \"title\": \"Message, full details\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"timeBrushUpperSection\",         \"showExportToExcel\": true,         \"exportToExcelOptions\": \"all\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"table\",         \"gridSettings\": {           \"filter\": true         },         \"sortBy\": []       },       \"name\": \"query - 11\"     },     {       \"type\": 1,       \"content\": {         \"json\": \"---\"       },       \"name\": \"text - 12\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nFakeData | union AzureDiagnostics\\r\\n| where (ResourceType == \\\"APPLICATIONGATEWAYS\\\" or ResourceType == \\\"FRONTDOORS\\\" or ResourceType == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\") and (\\\"{WAFType:label}\\\" == \\\"All\\\" or (ResourceType == \\\"APPLICATIONGATEWAYS\\\" and \\\"{WAFType:label}\\\" contains \\\"application gateway\\\") or (ResourceType == \\\"FRONTDOORS\\\" and  \\\"{WAFType:label}\\\" contains \\\"azure front door\\\") or (ResourceType==\\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\" and \\\"{WAFType:label}\\\" contains \\\"cdn\\\")) and (\\\"{WAF:label}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where Category == \\\"FrontdoorWebApplicationFirewallLog\\\" or (OperationName == \\\"ApplicationGatewayFirewall\\\" and Message contains \\\"attack\\\") or Category == \\\"WebApplicationFirewallLogs\\\"\\r\\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \\\"*\\\"\\r\\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\\r\\n| extend Action = iif(action_s == \\\"Blocked\\\", Action = \\\"Block\\\", action_s)\\r\\n| extend Action = iif(Action == \\\"Detected\\\", Action = \\\"Log\\\", Action)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\" \\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\" \\r\\n| summarize Amount = count() by Rule\\r\\n| order by Amount desc\\r\\n\\r\\n\",         \"size\": 0,         \"title\": \"Attacks events, by messages and filterable by rule name\",         \"noDataMessage\": \"Filtered messages are not attack events\",         \"timeContext\": {           \"durationMs\": 86400000         },         \"timeContextFromParameter\": \"TimeRange\",         \"exportFieldName\": \"\",         \"exportParameterName\": \"MessageFilter\",         \"exportDefaultValue\": \"{\\\"Rule\\\":\\\"*\\\"}\",         \"showExportToExcel\": true,         \"exportToExcelOptions\": \"all\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"table\",         \"gridSettings\": {           \"formatters\": [             {               \"columnMatch\": \"Amount\",               \"formatter\": 8,               \"formatOptions\": {                 \"palette\": \"blueDark\",                 \"showIcon\": true,                 \"aggregation\": \"Sum\"               }             }           ],           \"filter\": true         },         \"sortBy\": []       },       \"customWidth\": \"20\",       \"name\": \"query - 16\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let SelectedMS = dynamic({MessageFilter}); // reference to the above list of messages (Event trigger)\\r\\nlet Child = SelectedMS.Rule; // Used to choose a group of messages - redirects to the message which was grouped\\r\\nlet FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nFakeData | union AzureDiagnostics\\r\\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \\\"*\\\"\\r\\n| where (ResourceType == \\\"APPLICATIONGATEWAYS\\\" or ResourceType == \\\"FRONTDOORS\\\" or ResourceType == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\") and (\\\"{WAFType:label}\\\" == \\\"All\\\" or (ResourceType == \\\"APPLICATIONGATEWAYS\\\" and \\\"{WAFType:label}\\\" contains \\\"application gateway\\\") or (ResourceType == \\\"FRONTDOORS\\\" and  \\\"{WAFType:label}\\\" contains \\\"azure front door\\\") or (ResourceType==\\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\" and \\\"{WAFType:label}\\\" contains \\\"cdn\\\")) and (\\\"{WAF:label}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where Category == \\\"FrontdoorWebApplicationFirewallLog\\\" or (OperationName == \\\"ApplicationGatewayFirewall\\\" and Message contains \\\"attack\\\") or Category == \\\"WebApplicationFirewallLogs\\\" \\r\\n| extend Action = iif(action_s == \\\"Blocked\\\", Action = \\\"Block\\\", action_s)\\r\\n| extend Action = iif(Action == \\\"Detected\\\", Action = \\\"Log\\\", Action)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\" \\r\\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\\r\\n| where Rule == Child or Child == \\\"*\\\"\\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\"\\r\\n| summarize Amount = count() by Rule, bin(TimeGenerated, 1h), ResourceId\\r\\n| project Amount, Rule, TimeGenerated, ResourceId\\r\\n| order by Amount desc\",         \"size\": 0,         \"showAnalytics\": true,         \"title\": \"Attack events, by time\",         \"noDataMessage\": \"Filtered messages are not attack events\",         \"timeContext\": {           \"durationMs\": 86400000         },         \"timeContextFromParameter\": \"TimeRange\",         \"timeBrushParameterName\": \"timeBrushLowerSection\",         \"exportParameterName\": \"Message\",         \"exportDefaultValue\": \"{ \\\"Name\\\":\\\"\\\", \\\"Type\\\":\\\"*\\\"}\",         \"showExportToExcel\": true,         \"exportToExcelOptions\": \"all\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"areachart\"       },       \"customWidth\": \"80\",       \"name\": \"query - 14\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let SelectedMS = dynamic({MessageFilter}); // reference to the above list of messages (Event trigger)\\r\\nlet Child = SelectedMS.Rule; // Used to choose a group of messages - redirects to the message which was grouped\\r\\nlet FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nFakeData | union AzureDiagnostics\\r\\n| where (ResourceType == \\\"APPLICATIONGATEWAYS\\\" or ResourceType == \\\"FRONTDOORS\\\" or ResourceType == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\") and (\\\"{WAFType:label}\\\" == \\\"All\\\" or (ResourceType == \\\"APPLICATIONGATEWAYS\\\" and \\\"{WAFType:label}\\\" contains \\\"application gateway\\\") or (ResourceType == \\\"FRONTDOORS\\\" and  \\\"{WAFType:label}\\\" contains \\\"azure front door\\\") or (ResourceType==\\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\" and \\\"{WAFType:label}\\\" contains \\\"cdn\\\")) and (\\\"{WAF:label}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where Category == \\\"FrontdoorWebApplicationFirewallLog\\\" or (OperationName == \\\"ApplicationGatewayFirewall\\\" and Message contains \\\"attack\\\") or Category == \\\"WebApplicationFirewallLogs\\\"\\r\\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \\\"*\\\"\\r\\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\\r\\n| extend Action = iif(action_s == \\\"Blocked\\\", Action = \\\"Block\\\", action_s)\\r\\n| extend Action = iif(Action == \\\"Detected\\\", Action = \\\"Log\\\", Action)\\r\\n| extend TrackingID = strcat(transactionId_s, trackingReference_s)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\" \\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\"\\r\\n| where Rule == Child or Child == \\\"*\\\" \\r\\n| summarize count() by TrackingID\\r\\n| top 50 by count_ desc\\r\\n\",         \"size\": 0,         \"showAnalytics\": true,         \"title\": \"TrackingID filter\",         \"noDataMessage\": \"You've over filtered or you're missing this data.\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"timeBrushLowerSection\",         \"exportFieldName\": \"TrackingID\",         \"exportParameterName\": \"SelectedTrackingID\",         \"exportDefaultValue\": \"*\",         \"showExportToExcel\": true,         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"gridSettings\": {           \"rowLimit\": 500,           \"filter\": true,           \"sortBy\": [             {               \"itemKey\": \"TrackingID\",               \"sortOrder\": 2             }           ]         },         \"sortBy\": [           {             \"itemKey\": \"TrackingID\",             \"sortOrder\": 2           }         ]       },       \"customWidth\": \"20\",       \"name\": \"query - 12\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let SelectedMS = dynamic({MessageFilter}); // reference to the above list of messages (Event trigger)\\r\\nlet Child = SelectedMS.Rule; // Used to choose a group of messages - redirects to the message which was grouped\\r\\nlet FakeData = (datatable (Message:string,ruleName_s:string,clientIp_s:string,clientIP_s:string,action_s:string,transactionId_s:string,site_s:string,details_message_sRole:string,details_file_sRole:string,hostname_sRole:string,Role:string,trackingReference_s:string,ruleGroup_s:string,instanceId_s:string,ruleSetType_s:string,details_message_s:string,details_data_s:string,details_file_s:string,hostname_s:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\",\\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\",\\\"\\\",\\\"\\\",\\\"\\\",\\\"\\\",\\\"\\\" ]);\\r\\nFakeData | union AzureDiagnostics\\r\\n| where (ResourceType == \\\"APPLICATIONGATEWAYS\\\" or ResourceType == \\\"FRONTDOORS\\\" or ResourceType == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\") and (\\\"{WAFType:label}\\\" == \\\"All\\\" or (ResourceType == \\\"APPLICATIONGATEWAYS\\\" and \\\"{WAFType:label}\\\" contains \\\"application gateway\\\") or (ResourceType == \\\"FRONTDOORS\\\" and  \\\"{WAFType:label}\\\" contains \\\"azure front door\\\") or (ResourceType==\\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\" and \\\"{WAFType:label}\\\" contains \\\"cdn\\\")) and (\\\"{WAF:label}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where Category == \\\"FrontdoorWebApplicationFirewallLog\\\" or (OperationName == \\\"ApplicationGatewayFirewall\\\" and Message contains \\\"attack\\\") or Category == \\\"WebApplicationFirewallLogs\\\"\\r\\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \\\"*\\\"\\r\\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\\r\\n| extend Action = iif(action_s == \\\"Blocked\\\", Action = \\\"Block\\\", action_s)\\r\\n| extend Action = iif(Action == \\\"Detected\\\", Action = \\\"Log\\\", Action)\\r\\n| extend TrackingID = strcat(transactionId_s, trackingReference_s)\\r\\n| where '{SelectedTrackingID}' == TrackingID or '{SelectedTrackingID}' == \\\"*\\\" \\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\" \\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\"\\r\\n| where Rule == Child or Child == \\\"*\\\"\\r\\n| extend RuleGroup = ruleGroup_s, InstandUri = instanceId_s, RequestUri = requestUri_s, RuleSetType = ruleSetType_s, Message_Details = details_message_s, Data_Details = details_data_s, File_Details = details_file_s, Hostname = hostname_s\\r\\n| project TrackingID, TimeGenerated, Rule, ClientIP, RuleGroup, InstandUri, RequestUri, RuleSetType, Action, Message_Details, File_Details, Data_Details, Hostname, Category\",         \"size\": 0,         \"showAnalytics\": true,         \"title\": \"TrackingID Messages\",         \"noDataMessage\": \"You've over filtered or you're missing this data.\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"timeBrushLowerSection\",         \"showExportToExcel\": true,         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"gridSettings\": {           \"rowLimit\": 50         }       },       \"customWidth\": \"80\",       \"name\": \"query - 13\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let SelectedMS = dynamic({MessageFilter}); // reference to the above list of messages (Event trigger)\\r\\nlet Child = SelectedMS.Rule; // Used to choose a group of messages - redirects to the message which was grouped\\r\\nlet FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nFakeData | union AzureDiagnostics\\r\\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \\\"*\\\"\\r\\n| where (ResourceType == \\\"APPLICATIONGATEWAYS\\\" or ResourceType == \\\"FRONTDOORS\\\" or ResourceType == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\") and (\\\"{WAFType:label}\\\" == \\\"All\\\" or (ResourceType == \\\"APPLICATIONGATEWAYS\\\" and \\\"{WAFType:label}\\\" contains \\\"application gateway\\\") or (ResourceType == \\\"FRONTDOORS\\\" and  \\\"{WAFType:label}\\\" contains \\\"azure front door\\\") or (ResourceType==\\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\" and \\\"{WAFType:label}\\\" contains \\\"cdn\\\")) and (\\\"{WAF:label}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where Category == \\\"FrontdoorWebApplicationFirewallLog\\\" or (OperationName == \\\"ApplicationGatewayFirewall\\\" and Message contains \\\"attack\\\") or Category == \\\"WebApplicationFirewallLogs\\\"\\r\\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\\r\\n| extend Action = iif(action_s == \\\"Blocked\\\", Action = \\\"Block\\\", action_s)\\r\\n| extend Action = iif(Action == \\\"Detected\\\", Action = \\\"Log\\\", Action)\\r\\n| extend TrackingID = strcat(transactionId_s, trackingReference_s)\\r\\n| where '{SelectedTrackingID}' == TrackingID or '{SelectedTrackingID}' == \\\"*\\\" \\r\\n| where Rule == Child or Child == \\\"*\\\"\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\"\\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\"\\r\\n| summarize count() by ClientIP\\r\\n| top 10 by count_ desc\",         \"size\": 0,         \"showAnalytics\": true,         \"title\": \"Top 10 Attacking IP Addresses, filter to single IP address\",         \"noDataMessage\": \"Filtered messages are not attack events\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"timeBrushLowerSection\",         \"exportFieldName\": \"x\",         \"exportParameterName\": \"ClientIP\",         \"exportDefaultValue\": \"*\",         \"showExportToExcel\": true,         \"exportToExcelOptions\": \"all\",         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"barchart\",         \"tileSettings\": {           \"showBorder\": false,           \"titleContent\": {             \"columnMatch\": \"ClientIP\",             \"formatter\": 1           },           \"leftContent\": {             \"columnMatch\": \"count_\",             \"formatter\": 12,             \"formatOptions\": {               \"palette\": \"auto\"             },             \"numberFormat\": {               \"unit\": 17,               \"options\": {                 \"maximumSignificantDigits\": 3,                 \"maximumFractionDigits\": 2               }             }           }         },         \"graphSettings\": {           \"type\": 0,           \"topContent\": {             \"columnMatch\": \"ClientIP\",             \"formatter\": 1           },           \"centerContent\": {             \"columnMatch\": \"count_\",             \"formatter\": 1,             \"numberFormat\": {               \"unit\": 17,               \"options\": {                 \"maximumSignificantDigits\": 3,                 \"maximumFractionDigits\": 2               }             }           }         },         \"chartSettings\": {           \"showLegend\": true         },         \"mapSettings\": {           \"locInfo\": \"LatLong\",           \"sizeSettings\": \"count_\",           \"sizeAggregation\": \"Sum\",           \"legendMetric\": \"count_\",           \"legendAggregation\": \"Sum\",           \"itemColorSettings\": {             \"type\": \"heatmap\",             \"colorAggregation\": \"Sum\",             \"nodeColorField\": \"count_\",             \"heatmapPalette\": \"greenRed\"           }         }       },       \"customWidth\": \"25\",       \"name\": \"query - 12\"     },     {       \"type\": 3,       \"content\": {         \"version\": \"KqlItem/1.0\",         \"query\": \"let SelectedMS = dynamic({MessageFilter}); // reference to the above list of messages (Event trigger)\\r\\nlet Child = SelectedMS.Rule; // Used to choose a group of messages - redirects to the message which was grouped\\r\\nlet FakeData = (datatable (Message:string,ruleName_s:string,clientIp_s:string,clientIP_s:string,action_s:string,transactionId_s:string,site_s:string,details_message_sRole:string,details_file_sRole:string,hostname_sRole:string,Role:string,trackingReference_s:string,ruleGroup_s:string,instanceId_s:string,ruleSetType_s:string,details_message_s:string,details_data_s:string,details_file_s:string,hostname_s:string,requestUri_s:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\",\\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\",\\\"\\\",\\\"\\\",\\\"\\\",\\\"\\\",\\\"\\\",\\\"\\\" ]);\\r\\nFakeData | union AzureDiagnostics\\r\\n| where (ResourceType == \\\"APPLICATIONGATEWAYS\\\" or ResourceType == \\\"FRONTDOORS\\\" or ResourceType == \\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\") and (\\\"{WAFType:label}\\\" == \\\"All\\\" or (ResourceType == \\\"APPLICATIONGATEWAYS\\\" and \\\"{WAFType:label}\\\" contains \\\"application gateway\\\") or (ResourceType == \\\"FRONTDOORS\\\" and  \\\"{WAFType:label}\\\" contains \\\"azure front door\\\") or (ResourceType==\\\"CDNWEBAPPLICATIONFIREWALLPOLICIES\\\" and \\\"{WAFType:label}\\\" contains \\\"cdn\\\")) and (\\\"{WAF:label}\\\" == \\\"All\\\" or Resource in ({WAF}))\\r\\n| where Category == \\\"FrontdoorWebApplicationFirewallLog\\\" or (OperationName == \\\"ApplicationGatewayFirewall\\\" and Message contains \\\"attack\\\") or Category == \\\"WebApplicationFirewallLogs\\\"\\r\\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \\\"*\\\"\\r\\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\\r\\n| where Rule == Child or Child == \\\"*\\\"\\r\\n| extend Action = iif(action_s == \\\"Blocked\\\", Action = \\\"Block\\\", action_s)\\r\\n| extend Action = iif(Action == \\\"Detected\\\", Action = \\\"Log\\\", Action)\\r\\n| extend TrackingID = strcat(transactionId_s, trackingReference_s)\\r\\n| where '{SelectedTrackingID}' == TrackingID or '{SelectedTrackingID}' == \\\"*\\\" \\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\" \\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\"\\r\\n| where ('{ClientIP}' == ClientIP or '{ClientIP}' == \\\"*\\\")\\r\\n| extend RuleGroup = ruleGroup_s, InstandUri = instanceId_s, RequestUri = requestUri_s, RuleSetType = ruleSetType_s, Message_Details = details_message_s, Data_Details = details_data_s, File_Details = details_file_s, Hostname = hostname_s\\r\\n| project TimeGenerated, Rule, ClientIP, RuleGroup, InstandUri, RequestUri, RuleSetType, Action, Message_Details, File_Details, Data_Details, Hostname, Category\",         \"size\": 0,         \"title\": \"Attack messages of IP address\",         \"noDataMessage\": \"Filtered messages are not attack events\",         \"timeContext\": {           \"durationMs\": 0         },         \"timeContextFromParameter\": \"timeBrushLowerSection\",         \"showExportToExcel\": true,         \"queryType\": 0,         \"resourceType\": \"microsoft.operationalinsights/workspaces\",         \"visualization\": \"table\",         \"gridSettings\": {           \"filter\": true         }       },       \"customWidth\": \"75\",       \"showPin\": true,       \"name\": \"query - 13\"     }   ],     \"fromTemplateId\": \"sentinel-WebApplicationFirewallWAFTypeEvents\",     \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"   }",
                                             "category":  "workbook",
                                             "version":  "1.0",
                                             "sourceId":  "[resourceid('Microsoft.OperationalInsights/workspaces',parameters('workspacename'))]"
                                         },
                          "type":  "microsoft.insights/workbooks",
                          "kind":  "shared",
                          "apiVersion":  "2018-06-17-preview",
                          "location":  "[parameters('location')]"
                      }
                  ]
}
